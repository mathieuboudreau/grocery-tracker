<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>üõí Grocery Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; background: #0d1117; }
  body { font-family: 'DM Sans', sans-serif; color: #e2e8f0; -webkit-tap-highlight-color: transparent; }
  #root { display: flex; flex-direction: column; min-height: 100vh; }

  .header {
    background: linear-gradient(160deg, #1a2744 0%, #111827 100%);
    border-bottom: 1px solid #1e3a5f;
    padding: 16px 16px 0;
    position: sticky; top: 0; z-index: 100;
  }
  .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2px; }
  .logo  { font-size: 20px; font-weight: 800; color: #60a5fa; letter-spacing: -0.5px; }
  .stats { font-size: 12px; color: #64748b; margin-bottom: 12px; }

  /* Sync status pill */
  .sync-pill { display: inline-flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 999px; cursor: default; }
  .sync-pill.synced  { background: #14532d33; color: #4ade80; }
  .sync-pill.syncing { background: #1e3a5f;   color: #93c5fd; }
  .sync-pill.error   { background: #450a0a33; color: #fca5a5; }
  .sync-pill.idle    { background: #1e2d5033; color: #64748b; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .spin { display: inline-block; animation: spin 1s linear infinite; }

  /* Setup screen */
  .setup-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 32px 24px; text-align: center; }
  .setup-icon  { font-size: 56px; margin-bottom: 20px; }
  .setup-title { font-size: 22px; font-weight: 800; color: #60a5fa; margin-bottom: 8px; }
  .setup-desc  { font-size: 14px; color: #64748b; line-height: 1.6; margin-bottom: 28px; max-width: 320px; }
  .setup-input { width: 100%; max-width: 320px; background: #0d1117; border: 1.5px solid #1e3a5f; border-radius: 12px; padding: 14px 16px; color: #e2e8f0; font-size: 16px; font-family: inherit; margin-bottom: 12px; outline: none; }
  .setup-input:focus { border-color: #3b82f6; }

  .nav { display: flex; border-top: 1px solid #1e3a5f; }
  .nav-btn {
    flex: 1; border: none; background: transparent; padding: 10px 4px 12px;
    cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 3px;
    color: #475569; font-family: inherit; transition: color 0.15s;
  }
  .nav-btn.active { color: #60a5fa; border-bottom: 2px solid #60a5fa; }
  .nav-btn .nav-icon  { font-size: 20px; line-height: 1; }
  .nav-btn .nav-label { font-size: 11px; font-weight: 600; }

  .page { flex: 1; padding: 16px; max-width: 680px; margin: 0 auto; width: 100%; }

  .card { background: #161d2e; border: 1px solid #1e3a5f; border-radius: 14px; padding: 16px; margin-bottom: 12px; }

  .field { margin-bottom: 14px; }
  .field-row { display: grid; gap: 12px; margin-bottom: 14px; }
  .field-row.cols-2 { grid-template-columns: 1fr 1fr; }
  .field-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }

  label.lbl { display: block; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 5px; }

  input, select {
    width: 100%; background: #0d1117; border: 1.5px solid #1e3a5f; border-radius: 10px;
    padding: 12px 14px; color: #e2e8f0; font-size: 16px;
    font-family: inherit; appearance: none; -webkit-appearance: none;
    transition: border-color 0.15s;
  }
  input:focus, select:focus { outline: none; border-color: #3b82f6; }
  select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px;
  }

  .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; border: none; border-radius: 12px; padding: 14px 20px; font-size: 15px; font-weight: 700; font-family: inherit; cursor: pointer; transition: opacity 0.15s; width: 100%; margin-bottom: 8px; }
  .btn:active { opacity: 0.75; }
  .btn-primary   { background: #2563eb; color: #fff; }
  .btn-secondary { background: #1e2d50; color: #93c5fd; }
  .btn-danger    { background: #450a0a; color: #fca5a5; }
  .btn-success   { background: #14532d; color: #86efac; }
  .btn-warning   { background: #451a03; color: #fcd34d; }
  .btn-sm { padding: 8px 14px; font-size: 13px; width: auto; margin-bottom: 0; border-radius: 8px; }

  .calc-preview { background: #0d1117; border: 1px solid #1e3a5f; border-radius: 10px; padding: 12px 14px; margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 12px; }
  .calc-lbl { font-size: 10px; color: #64748b; font-weight: 700; text-transform: uppercase; }
  .calc-val { font-size: 16px; font-weight: 800; color: #4ade80; }

  .entry-card { background: #161d2e; border: 1px solid #1e3a5f; border-radius: 14px; padding: 14px; margin-bottom: 10px; }
  .entry-top  { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 8px; }
  .entry-product { font-size: 16px; font-weight: 700; color: #93c5fd; }
  .entry-brand   { font-size: 13px; font-weight: 600; color: #7dd3fc; opacity: 0.8; margin-top: 1px; }
  .entry-meta    { font-size: 12px; color: #64748b; margin-top: 3px; }
  .entry-actions { display: flex; gap: 6px; flex-shrink: 0; margin-left: 8px; }

  .entry-prices { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
  .price-pill { background: #0d1117; border: 1px solid #1e3a5f; border-radius: 8px; padding: 5px 10px; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 1px; }
  .price-pill .plbl { font-size: 10px; color: #64748b; font-weight: 700; text-transform: uppercase; }
  .price-pill .pval { font-weight: 700; color: #e2e8f0; }
  .price-pill.main .pval { color: #60a5fa; font-size: 15px; }
  .sale-badge { display: inline-block; background: #14532d; color: #4ade80; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 999px; }

  /* Search bar */
  .search-wrap { position: relative; margin-bottom: 12px; }
  .search-wrap input { padding-left: 40px; }
  .search-icon { position: absolute; left: 13px; top: 50%; transform: translateY(-50%); font-size: 16px; pointer-events: none; }
  .search-clear { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #64748b; font-size: 18px; cursor: pointer; padding: 0; line-height: 1; width: auto; margin: 0; }

  /* Tags input */
  .tag-input-wrap { background: #0d1117; border: 1.5px solid #1e3a5f; border-radius: 10px; padding: 8px 10px; display: flex; flex-wrap: wrap; gap: 6px; cursor: text; transition: border-color 0.15s; }
  .tag-input-wrap:focus-within { border-color: #3b82f6; }
  .tag-chip { display: inline-flex; align-items: center; gap: 4px; background: #1e3a5f; color: #93c5fd; border-radius: 999px; padding: 3px 10px; font-size: 13px; font-weight: 600; }
  .tag-chip button { background: none; border: none; color: #64748b; cursor: pointer; font-size: 15px; line-height: 1; padding: 0; width: auto; margin: 0; display: flex; align-items: center; }
  .tag-chip button:hover { color: #fca5a5; }
  .tag-input { background: none; border: none; outline: none; color: #e2e8f0; font-size: 15px; font-family: inherit; padding: 4px; min-width: 80px; flex: 1; width: auto; }
  .tag-suggestions { background: #161d2e; border: 1px solid #1e3a5f; border-radius: 10px; margin-top: 4px; overflow: hidden; }
  .tag-suggestion { padding: 10px 14px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
  .tag-suggestion:hover, .tag-suggestion.focused { background: #1e2d50; }
  .tag-suggestion-count { font-size: 11px; color: #64748b; margin-left: auto; }

  /* Entry card tags */
  .entry-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
  .entry-tag { background: #1e3a5f; color: #7dd3fc; border-radius: 999px; padding: 2px 9px; font-size: 11px; font-weight: 600; cursor: pointer; }
  .entry-tag:hover { background: #1e4d7a; }

  .tag-filter-banner { background: #0f2744; border: 1px solid #1e4d7a; border-radius: 10px; padding: 8px 12px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; font-size: 13px; }
  .tag-filter-banner span { color: #7dd3fc; }
  .tag-filter-banner button { background: none; border: none; color: #64748b; font-size: 18px; cursor: pointer; padding: 0; width: auto; margin: 0; line-height: 1; }

  .analytics-tag-bar { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
  .analytics-tag-chip { background: #161d2e; border: 1.5px solid #1e3a5f; border-radius: 999px; padding: 5px 12px; font-size: 12px; font-weight: 600; color: #64748b; cursor: pointer; font-family: inherit; }
  .analytics-tag-chip.active { border-color: #7dd3fc; color: #7dd3fc; background: #0f2744; }

  .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 12px; scrollbar-width: none; }
  .filter-bar::-webkit-scrollbar { display: none; }
  .filter-chip { flex-shrink: 0; background: #161d2e; border: 1.5px solid #1e3a5f; border-radius: 999px; padding: 6px 14px; font-size: 13px; font-weight: 600; color: #64748b; cursor: pointer; white-space: nowrap; font-family: inherit; }
  .filter-chip.active { border-color: #3b82f6; color: #60a5fa; background: #172554; }

  .sort-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
  .sort-row label { font-size: 12px; color: #64748b; white-space: nowrap; }
  .sort-row select { font-size: 13px; padding: 7px 30px 7px 10px; border-radius: 8px; }

  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
  .stat-card { background: #161d2e; border: 1px solid #1e3a5f; border-radius: 14px; padding: 16px; text-align: center; }
  .stat-val  { font-size: 32px; font-weight: 800; line-height: 1; }
  .stat-lbl  { font-size: 12px; color: #64748b; margin-top: 4px; }

  .section-title { font-size: 14px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 10px; }

  .product-row { border-bottom: 1px solid #1e3a5f; padding: 14px 0; }
  .product-row:last-child { border-bottom: none; }
  .product-name { font-size: 15px; font-weight: 700; color: #93c5fd; margin-bottom: 4px; }

  /* Brand sub-rows within a product */
  .brand-block { margin-top: 10px; padding: 10px; background: #0d1117; border-radius: 10px; border: 1px solid #1e3a5f; }
  .brand-title { font-size: 12px; font-weight: 700; color: #7dd3fc; margin-bottom: 6px; }

  .store-bars { display: flex; flex-direction: column; gap: 6px; }
  .store-bar  { display: flex; align-items: center; gap: 10px; }
  .store-name { font-size: 13px; color: #94a3b8; width: 100px; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .bar-track  { flex: 1; background: #1e3a5f; border-radius: 999px; height: 8px; overflow: hidden; }
  .bar-fill   { height: 100%; border-radius: 999px; }
  .store-price { font-size: 13px; font-weight: 700; width: 75px; text-align: right; }

  .empty { text-align: center; padding: 48px 16px; color: #475569; }
  .empty-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-text { font-size: 15px; }

  /* Share / sync section */
  .sync-section { margin-bottom: 12px; }
  .sync-row { display: flex; gap: 8px; }
  .sync-row .btn { margin-bottom: 0; }
  .sync-note { font-size: 12px; color: #64748b; margin-top: 8px; line-height: 1.5; }

  .toast {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
    background: #1e3a5f; color: #e2e8f0; padding: 10px 20px; border-radius: 999px;
    font-size: 14px; font-weight: 600; z-index: 999; white-space: nowrap;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    animation: fadeInOut 2.5s ease forwards;
  }
  @keyframes fadeInOut { 0%{opacity:0;transform:translateX(-50%) translateY(10px)} 15%{opacity:1;transform:translateX(-50%) translateY(0)} 75%{opacity:1} 100%{opacity:0} }

  @media (min-width: 480px) {
    .stat-grid { grid-template-columns: repeat(4, 1fr); }
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useRef, useCallback } = React;

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
function deriveRow(row) {
  const tp = parseFloat(row.totalPrice), u = parseInt(row.units);
  const w  = parseFloat(row.weight),    rp = parseFloat(row.regPrice);
  let pricePerUnit=null, pricePerKg=null, pricePer100g=null, saving=null;
  if (!isNaN(tp)) {
    if (!isNaN(u) && u > 0) pricePerUnit = +(tp/u).toFixed(3);
    if (!isNaN(w) && w > 0 && row.unit) {
      const ul = (row.unit||"").toLowerCase();
      const g = ul==="g"||ul==="ml"?w : ul==="kg"||ul==="l"?w*1000 : ul==="oz"?w*28.3495 : ul==="lb"?w*453.592 : null;
      if (g) { pricePerKg=+(tp/g*1000).toFixed(3); pricePer100g=+(tp/g*100).toFixed(3); }
    }
    if (!isNaN(rp) && rp > 0) saving = +(rp-tp).toFixed(2);
  }
  return { ...row, pricePerUnit, pricePerKg, pricePer100g, saving };
}

const fmt$   = v  => v!=null && !isNaN(v) ? `$${Number(v).toFixed(2)}` : null;
const fmt$3  = v  => v!=null && !isNaN(v) ? `$${Number(v).toFixed(3)}` : null;
const uid    = () => Date.now().toString(36)+Math.random().toString(36).slice(2);
const TODAY  = () => new Date().toISOString().slice(0,10);
const avg    = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : null;
const minSafe = arr => arr.length ? Math.min(...arr) : null;
const maxSafe = arr => arr.length ? Math.max(...arr) : null;

/* Determine the best display unit for a set of entries and convert $/kg values */
function bestUnitLabel(rows) {
  const unitCounts = {};
  rows.forEach(r => { if (r.unit) { const u = (r.unit||"").toLowerCase(); unitCounts[u] = (unitCounts[u]||0)+1; } });
  const sorted = Object.entries(unitCounts).sort((a,b)=>b[1]-a[1]);
  if (!sorted.length) return null;
  const top = sorted[0][0];
  // Map unit ‚Üí { label for display, multiplier to convert $/kg ‚Üí $/display }
  const map = {
    "g":  { label:"$/100g", mult: 1/10 },
    "kg": { label:"$/kg",   mult: 1 },
    "ml": { label:"$/100mL",mult: 1/10 },
    "l":  { label:"$/L",    mult: 1 },
    "oz": { label:"$/oz",   mult: 0.0283495 },
    "lb": { label:"$/lb",   mult: 0.453592 },
  };
  return map[top] || map["g"];
}
const EMPTY  = { product:"",brand:"",category:"",store:"",onSale:"",units:"",weight:"",unit:"",totalPrice:"",regPrice:"",notes:"",tags:[] };

const LAMBDA_URL = "https://3jdo4h6d3mmemlnpte734n3wny0shxzn.lambda-url.ca-central-1.on.aws/";

function mergeEntries(local, incoming) {
  const map = new Map(local.map(e => [e.id, e]));
  incoming.forEach(row => {
    const incomingTs = row.updatedAt || "0";
    const existing   = map.get(row.id);
    const existingTs = existing?.updatedAt || "0";
    if (!existing || incomingTs > existingTs) {
      map.set(row.id, deriveRow({ ...row, tags: row.tags||[], updatedAt: row.updatedAt || new Date().toISOString() }));
    }
  });
  return [...map.values()];
}

/* ‚îÄ‚îÄ Tag Input ‚îÄ‚îÄ */
function TagInput({ tags, onChange, allTags }) {
  const [input,    setInput]    = useState("");
  const [focused,  setFocused]  = useState(false);
  const [focusIdx, setFocusIdx] = useState(-1);
  const inputRef = useRef();

  const suggestions = useMemo(() => {
    if (!input.trim()) return [];
    const q = input.toLowerCase();
    return allTags.filter(t => t.tag.toLowerCase().includes(q) && !tags.includes(t.tag)).slice(0, 6);
  }, [input, allTags, tags]);

  const addTag = tag => {
    const clean = tag.trim().toLowerCase().replace(/\s+/g, "-");
    if (clean && !tags.includes(clean)) onChange([...tags, clean]);
    setInput(""); setFocusIdx(-1);
  };
  const removeTag = tag => onChange(tags.filter(t => t !== tag));
  const handleKey = e => {
    if ((e.key==="Enter"||e.key===",") && input.trim()) {
      e.preventDefault();
      focusIdx>=0&&suggestions[focusIdx] ? addTag(suggestions[focusIdx].tag) : addTag(input);
    } else if (e.key==="Backspace"&&!input&&tags.length) { removeTag(tags[tags.length-1]); }
    else if (e.key==="ArrowDown") { e.preventDefault(); setFocusIdx(i=>Math.min(i+1,suggestions.length-1)); }
    else if (e.key==="ArrowUp")   { e.preventDefault(); setFocusIdx(i=>Math.max(i-1,-1)); }
    else if (e.key==="Escape")    { setInput(""); setFocusIdx(-1); }
  };

  return (
    <div>
      <div className="tag-input-wrap" onClick={()=>inputRef.current?.focus()}>
        {tags.map(t=>(
          <span key={t} className="tag-chip">{t}
            <button type="button" onClick={e=>{e.stopPropagation();removeTag(t);}}>√ó</button>
          </span>
        ))}
        <input ref={inputRef} className="tag-input" value={input}
          placeholder={tags.length?"":"e.g. sliced, honey, organic‚Ä¶"}
          onChange={e=>{setInput(e.target.value);setFocusIdx(-1);}}
          onKeyDown={handleKey}
          onFocus={()=>setFocused(true)}
          onBlur={()=>setTimeout(()=>{setFocused(false);setFocusIdx(-1);},150)} />
      </div>
      {focused&&suggestions.length>0&&(
        <div className="tag-suggestions">
          {suggestions.map((s,i)=>(
            <div key={s.tag} className={`tag-suggestion${i===focusIdx?" focused":""}`}
              onMouseDown={e=>{e.preventDefault();addTag(s.tag);}}>
              <span>{s.tag}</span>
              <span className="tag-suggestion-count">{s.count}√ó</span>
            </div>
          ))}
        </div>
      )}
      <div style={{fontSize:11,color:"#475569",marginTop:5}}>Press Enter or comma to add ¬∑ Backspace to remove</div>
    </div>
  );
}

/* ‚îÄ‚îÄ App ‚îÄ‚îÄ */
function App() {
  const [secret,      setSecret]      = useState(()=>localStorage.getItem("gt_secret")||"");
  const [secretInput, setSecretInput] = useState("");
  const [entries, setEntries] = useState(() => {
    try {
      const old = localStorage.getItem("gt_v2");
      if (old) {
        const parsed = JSON.parse(old);
        if (Array.isArray(parsed) && parsed.length) localStorage.setItem("gt_v3", old);
        localStorage.removeItem("gt_v2");
      }
      return JSON.parse(localStorage.getItem("gt_v3")||"[]");
    } catch { return []; }
  });
  const [tab,        setTab]        = useState("db");
  const [form,       setForm]       = useState({ ...EMPTY, date:TODAY() });
  const [editId,     setEditId]     = useState(null);
  const [sortBy,     setSortBy]     = useState("date");
  const [storeFilter,setStoreFilter]= useState("all");
  const [searchQ,    setSearchQ]    = useState("");
  const [tagFilter,  setTagFilter]  = useState(null);
  const [analyticsTag,setAnalyticsTag]= useState(null);
  const [analyticsSearch,setAnalyticsSearch]= useState("");
  const [syncStatus,  setSyncStatus]  = useState("idle");
  const [lastSynced,  setLastSynced]  = useState(null);
  const [toast,      setToast]      = useState(null);
  const importRef = useRef();
  const searchRef = useRef();
  const analyticsSearchRef = useRef();
  const pushTimer = useRef(null);
  const isFirstRender = useRef(true);

  useEffect(() => {
    try { localStorage.setItem("gt_v3", JSON.stringify(entries)); } catch {}
  }, [entries]);

  const showToast = msg => {
    setToast(msg);
    setTimeout(() => setToast(null), 2600);
  };

  /* ‚îÄ‚îÄ Cloud pull ‚îÄ‚îÄ */
  const pullCloud = useCallback(async (sk) => {
    const key = sk||secret; if (!key) return;
    setSyncStatus("syncing");
    try {
      const res = await fetch(LAMBDA_URL, { headers:{"x-secret":key} });
      if (res.status===403) { setSyncStatus("error"); showToast("‚ùå Wrong secret key"); return; }
      if (!res.ok) throw new Error();
      const data = await res.json();
      const remote = data.entries||[];
      setEntries(prev => {
        const merged = mergeEntries(prev, remote);
        pushCloud(merged, key);
        return merged;
      });
      setLastSynced(new Date()); setSyncStatus("synced");
    } catch { setSyncStatus("error"); showToast("‚ö†Ô∏è Sync failed ‚Äî working offline"); }
  }, [secret]);

  /* ‚îÄ‚îÄ Cloud push ‚îÄ‚îÄ */
  const pushCloud = useCallback(async (entriesToPush, sk) => {
    const key = sk||secret; if (!key) return;
    setSyncStatus("syncing");
    try {
      const res = await fetch(LAMBDA_URL, {
        method:"PUT",
        headers:{"Content-Type":"application/json","x-secret":key},
        body: JSON.stringify({entries: entriesToPush})
      });
      if (!res.ok) throw new Error();
      setLastSynced(new Date()); setSyncStatus("synced");
    } catch { setSyncStatus("error"); }
  }, [secret]);

  // Pull on mount (once secret is set)
  useEffect(()=>{ if (secret) pullCloud(secret); },[]);

  // Debounced push whenever entries change (skip initial mount)
  useEffect(()=>{
    if (isFirstRender.current) { isFirstRender.current=false; return; }
    if (!secret) return;
    clearTimeout(pushTimer.current);
    pushTimer.current = setTimeout(()=>pushCloud(entries), 1500);
    return ()=>clearTimeout(pushTimer.current);
  }, [entries]);

  const saveSecret = () => {
    const s = secretInput.trim(); if (!s) return;
    localStorage.setItem("gt_secret",s);
    setSecret(s);
    pullCloud(s);
  };

  const allProducts = useMemo(() => [...new Set(entries.map(e=>e.product).filter(Boolean))].sort(), [entries]);
  const allBrands   = useMemo(() => [...new Set(entries.map(e=>e.brand).filter(Boolean))].sort(),   [entries]);
  const allStores   = useMemo(() => [...new Set(entries.map(e=>e.store).filter(Boolean))].sort(),   [entries]);
  const allCats     = useMemo(() => [...new Set(entries.map(e=>e.category).filter(Boolean))].sort(),[entries]);
  const allTags     = useMemo(()=>{
    const counts={};
    entries.forEach(e=>(e.tags||[]).forEach(t=>{counts[t]=(counts[t]||0)+1;}));
    return Object.entries(counts).map(([tag,count])=>({tag,count})).sort((a,b)=>b.count-a.count);
  },[entries]);

  const sf = k => e => setForm(f=>({...f,[k]:e.target.value}));

  const save = () => {
    if (!form.product.trim()) return;
    const row = deriveRow({ ...form, id: editId||uid(), tags: form.tags||[], updatedAt: new Date().toISOString() });
    setEntries(prev => editId ? prev.map(e=>e.id===editId?row:e) : [...prev, row]);
    setForm({ ...EMPTY, date:TODAY() }); setEditId(null); setTab("db");
  };

  const startEdit = e => { setForm({...e, tags:e.tags||[]}); setEditId(e.id); setTab("add"); };
  const cancel    = () => { setForm({...EMPTY,date:TODAY()}); setEditId(null); setTab("db"); };
  const del       = id => { if (window.confirm("Delete this entry?")) setEntries(p=>p.filter(e=>e.id!==id)); };
  const switchTab = id => { if(id!=="add"){setEditId(null);setForm({...EMPTY,date:TODAY()});} setTab(id); };
  const filterByTag = tag => { setTagFilter(tag); setSearchQ(""); };

  /* ‚îÄ‚îÄ Export ‚îÄ‚îÄ */
  const exportData = () => {
    const payload = { version:1, exportedAt: new Date().toISOString(), entries };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href = url;
    a.download = `grocery-tracker-${TODAY()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast("‚úÖ Exported!");
  };

  /* ‚îÄ‚îÄ Import (merge by id, newer wins) ‚îÄ‚îÄ */
  const importData = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const parsed = JSON.parse(ev.target.result);
        const incoming = parsed.entries || parsed; // support bare array too
        if (!Array.isArray(incoming)) throw new Error("Invalid format");
        setEntries(prev => mergeEntries(prev, incoming));
        showToast(`‚úÖ Imported ${incoming.length} entries (merged)`);
      } catch {
        showToast("‚ùå Import failed ‚Äî invalid file");
      }
    };
    reader.readAsText(file);
    e.target.value = ""; // reset so same file can be re-imported
  };

  const filtered = useMemo(() => {
    const q=searchQ.toLowerCase();
    return entries
      .filter(e => {
        if (storeFilter!=="all" && e.store!==storeFilter) return false;
        if (tagFilter && !(e.tags||[]).includes(tagFilter)) return false;
        if (!q) return true;
        return (e.product||"").toLowerCase().includes(q)||(e.brand||"").toLowerCase().includes(q)||
               (e.category||"").toLowerCase().includes(q)||(e.store||"").toLowerCase().includes(q)||
               (e.tags||[]).some(t=>t.includes(q));
      })
      .sort((a,b) => {
        if (sortBy==="date")    return (b.date||"").localeCompare(a.date||"");
        if (sortBy==="product") return (a.product||"").localeCompare(b.product||"");
        if (sortBy==="brand")   return (a.brand||"").localeCompare(b.brand||"");
        if (sortBy==="price")   return parseFloat(a.totalPrice)-parseFloat(b.totalPrice);
        return 0;
      });
  }, [entries, storeFilter, searchQ, tagFilter, sortBy]);

  /* ‚îÄ‚îÄ Analytics: group by product ‚Üí brand ‚Üí store ‚îÄ‚îÄ */
  const productAnalytics = useMemo(() => {
    const base = analyticsTag ? entries.filter(e=>(e.tags||[]).includes(analyticsTag)) : entries;
    const products=[...new Set(base.map(e=>e.product).filter(Boolean))].sort();
    return products.map(p => {
    const pRows = base.filter(e=>e.product===p);
    const prices = pRows.map(r=>parseFloat(r.totalPrice)).filter(x=>!isNaN(x));

    // Determine best display unit for this product
    const unitInfo = bestUnitLabel(pRows);
    const ppkgAll = pRows.map(r=>r.pricePerKg).filter(x=>x!=null);
    let unitLabel=null, unitAvg=null, unitMin=null, unitMax=null;
    if (unitInfo && ppkgAll.length) {
      const converted = ppkgAll.map(v => v * unitInfo.mult);
      unitLabel = unitInfo.label;
      unitAvg = avg(converted);
      unitMin = minSafe(converted);
      unitMax = maxSafe(converted);
    }

    // brands within this product
    const brandsInProduct = [...new Set(pRows.map(e=>e.brand||"(no brand)"))].sort();
    const brandData = brandsInProduct.map(b => {
      const bRows = pRows.filter(e=>(e.brand||"(no brand)")===b);
      const bPrices = bRows.map(r=>parseFloat(r.totalPrice)).filter(x=>!isNaN(x));
      const ppkg    = bRows.map(r=>r.pricePerKg).filter(x=>x!=null);

      // Per-unit stats for this brand (using same unit as product)
      let bUnitAvg=null, bUnitMin=null, bUnitMax=null;
      if (unitInfo && ppkg.length) {
        const bc = ppkg.map(v => v * unitInfo.mult);
        bUnitAvg = avg(bc);
        bUnitMin = minSafe(bc);
        bUnitMax = maxSafe(bc);
      }

      // stores for this brand
      const byStore = {};
      bRows.forEach(r => {
        if (r.store && !isNaN(parseFloat(r.totalPrice))) {
          byStore[r.store]=byStore[r.store]||[];
          byStore[r.store].push(parseFloat(r.totalPrice));
        }
      });
      const storeAvgs = Object.entries(byStore).map(([s,ps])=>({store:s,avg:avg(ps)})).sort((a,b)=>a.avg-b.avg);
      const maxAvg = storeAvgs.length ? storeAvgs.at(-1).avg : 1;

      // Per-unit store averages
      const byStoreUnit = {};
      bRows.forEach(r => {
        if (r.store && r.pricePerKg!=null && unitInfo) {
          byStoreUnit[r.store]=byStoreUnit[r.store]||[];
          byStoreUnit[r.store].push(r.pricePerKg * unitInfo.mult);
        }
      });
      const storeUnitAvgs = Object.entries(byStoreUnit).map(([s,ps])=>({store:s,avg:avg(ps)})).sort((a,b)=>a.avg-b.avg);
      const maxUnitAvg = storeUnitAvgs.length ? storeUnitAvgs.at(-1).avg : 1;

      return { brand:b, count:bRows.length, avgPrice:avg(bPrices), minPrice:minSafe(bPrices), maxPrice:maxSafe(bPrices), avgPpkg:avg(ppkg), bUnitAvg, bUnitMin, bUnitMax, storeAvgs, maxAvg, storeUnitAvgs, maxUnitAvg };
    });

    return { product:p, count:pRows.length, avgPrice:avg(prices), minPrice:minSafe(prices), maxPrice:maxSafe(prices), avgPpkg:avg(ppkgAll), unitLabel, unitAvg, unitMin, unitMax, brandData };
    });
  }, [entries, analyticsTag]);

  const filteredAnalytics = useMemo(() => {
    if (!analyticsSearch.trim()) return productAnalytics;
    const q = analyticsSearch.toLowerCase();
    return productAnalytics.filter(p =>
      p.product.toLowerCase().includes(q) ||
      p.brandData.some(b => b.brand.toLowerCase().includes(q))
    );
  }, [productAnalytics, analyticsSearch]);

  const preview = deriveRow(form);

  const syncLabel = syncStatus==="syncing" ? <><span className="spin">‚öôÔ∏è</span> Syncing‚Ä¶</>
                  : syncStatus==="synced"  ? `‚úì ${lastSynced?.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`
                  : syncStatus==="error"   ? "‚ö†Ô∏è Sync error"
                  : "‚óã Not synced";

  /* ‚îÄ‚îÄ First launch: no secret ‚îÄ‚îÄ */
  if (!secret) return (
    <div className="setup-screen">
      <div className="setup-icon">üîë</div>
      <div className="setup-title">Enter your sync key</div>
      <div className="setup-desc">This is the secret you set in the Lambda function. It stays on your device only ‚Äî it's never stored anywhere except your browser.</div>
      <input className="setup-input" type="password" placeholder="Your secret key‚Ä¶"
        value={secretInput} onChange={e=>setSecretInput(e.target.value)}
        onKeyDown={e=>e.key==="Enter"&&saveSecret()} autoFocus />
      <button className="btn btn-primary" style={{maxWidth:320}} onClick={saveSecret}>Connect ‚Üí</button>
    </div>
  );

  return (
    <div style={{display:"flex",flexDirection:"column",minHeight:"100vh"}}>

      {/* Header */}
      <div className="header">
        <div className="header-top">
          <div className="logo">üõí Grocery Tracker</div>
          <span className={`sync-pill ${syncStatus}`}>{syncLabel}</span>
        </div>
        <div className="stats">{entries.length} entries ¬∑ {allProducts.length} products ¬∑ {allStores.length} stores</div>
        <nav className="nav">
          {[["db","üóÇÔ∏è","Database"],["add","‚ûï","Add"],["analytics","üìä","Analytics"],["sync","‚òÅÔ∏è","Sync"]].map(([id,icon,lbl])=>(
            <button key={id} className={`nav-btn${tab===id?" active":""}`} onClick={()=>switchTab(id)}>
              <span className="nav-icon">{icon}</span>
              <span className="nav-label">{lbl}</span>
            </button>
          ))}
        </nav>
      </div>

      {/* ‚îÄ‚îÄ DATABASE ‚îÄ‚îÄ */}
      {tab==="db" && (
        <div className="page">
          <div className="search-wrap">
            <span className="search-icon">üîç</span>
            <input ref={searchRef} value={searchQ}
              onChange={e=>{setSearchQ(e.target.value);setTagFilter(null);}}
              placeholder="Search product, brand, tag‚Ä¶" />
            {searchQ&&<button className="search-clear" onClick={()=>{setSearchQ("");searchRef.current?.focus();}}>√ó</button>}
          </div>
          {tagFilter&&(
            <div className="tag-filter-banner">
              <span>üè∑Ô∏è Tag: <strong>{tagFilter}</strong></span>
              <button onClick={()=>setTagFilter(null)}>√ó</button>
            </div>
          )}
          <div className="filter-bar">
            <button className={`filter-chip${storeFilter==="all"?" active":""}`} onClick={()=>setStoreFilter("all")}>All stores</button>
            {allStores.map(s=>(
              <button key={s} className={`filter-chip${storeFilter===s?" active":""}`} onClick={()=>setStoreFilter(s)}>{s}</button>
            ))}
          </div>

          <div className="sort-row">
            <label>Sort by</label>
            <select value={sortBy} onChange={e=>setSortBy(e.target.value)}>
              <option value="date">Date (newest)</option>
              <option value="product">Product A‚ÄìZ</option>
              <option value="brand">Brand A‚ÄìZ</option>
              <option value="price">Price (low‚Äìhigh)</option>
            </select>
          </div>

          {filtered.length===0
            ? <div className="empty"><div className="empty-icon">{entries.length===0?"üõí":"üîç"}</div><div className="empty-text">{entries.length===0?"No entries yet.\nTap Add to get started.":"No results found."}</div></div>
            : filtered.map(e=>(
                <div className="entry-card" key={e.id}>
                  <div className="entry-top">
                    <div style={{minWidth:0}}>
                      <div className="entry-product">{e.product}</div>
                      {e.brand && <div className="entry-brand">{e.brand}</div>}
                      <div className="entry-meta">
                        {[e.store, e.category, e.date].filter(Boolean).join(" ¬∑ ")}
                        {e.onSale==="Y" && <> &nbsp;<span className="sale-badge">SALE</span></>}
                      </div>
                    </div>
                    <div className="entry-actions">
                      <button className="btn btn-secondary btn-sm" onClick={()=>startEdit(e)}>‚úèÔ∏è</button>
                      <button className="btn btn-danger btn-sm"    onClick={()=>del(e.id)}>üóëÔ∏è</button>
                    </div>
                  </div>
                  <div className="entry-prices">
                    {fmt$(e.totalPrice)   && <div className="price-pill main"><span className="plbl">Total</span><span className="pval">{fmt$(e.totalPrice)}</span></div>}
                    {fmt$(e.pricePerUnit) && <div className="price-pill"><span className="plbl">/ unit</span><span className="pval">{fmt$(e.pricePerUnit)}</span></div>}
                    {fmt$(e.pricePer100g) && <div className="price-pill"><span className="plbl">/ 100g</span><span className="pval">{fmt$(e.pricePer100g)}</span></div>}
                    {fmt$(e.pricePerKg)   && <div className="price-pill"><span className="plbl">/ kg</span><span className="pval">{fmt$(e.pricePerKg)}</span></div>}
                    {e.saving>0           && <div className="price-pill"><span className="plbl">Saving</span><span className="pval" style={{color:"#4ade80"}}>{fmt$(e.saving)}</span></div>}
                    {e.weight&&e.unit     && <div className="price-pill"><span className="plbl">Size</span><span className="pval">{e.weight}{e.unit}</span></div>}
                  </div>
                  {e.notes && <div style={{marginTop:8,fontSize:12,color:"#64748b"}}>üìù {e.notes}</div>}
                  {(e.tags||[]).length>0&&<div className="entry-tags">{(e.tags||[]).map(t=><span key={t} className="entry-tag" onClick={()=>filterByTag(t)}>#{t}</span>)}</div>}
                </div>
              ))
          }
        </div>
      )}

      {/* ‚îÄ‚îÄ ADD / EDIT ‚îÄ‚îÄ */}
      {tab==="add" && (
        <div className="page">
          <div className="card">
            <h2 style={{fontSize:18,fontWeight:800,color:"#60a5fa",marginBottom:20}}>{editId?"‚úèÔ∏è Edit Entry":"‚ûï New Entry"}</h2>

            <div className="field-row cols-2">
              <div>
                <label className="lbl">Date</label>
                <input type="date" value={form.date||""} onChange={sf("date")} />
              </div>
              <div>
                <label className="lbl">On Sale?</label>
                <select value={form.onSale||""} onChange={sf("onSale")}>
                  <option value="">‚Äî</option>
                  <option value="Y">‚úÖ Yes</option>
                  <option value="N">No</option>
                </select>
              </div>
            </div>

            <div className="field">
              <label className="lbl">Product Name <span style={{color:"#64748b",fontWeight:400,textTransform:"none",letterSpacing:0}}>‚Äî generic name, e.g. "Butter"</span></label>
              <input value={form.product||""} onChange={sf("product")} placeholder="e.g. Butter, Milk, Pasta" list="prod-list" />
              <datalist id="prod-list">{allProducts.map(p=><option key={p} value={p}/>)}</datalist>
            </div>

            <div className="field">
              <label className="lbl">Brand <span style={{color:"#64748b",fontWeight:400,textTransform:"none",letterSpacing:0}}>‚Äî e.g. "Lactantia"</span></label>
              <input value={form.brand||""} onChange={sf("brand")} placeholder="e.g. Natrel, PC, No Name‚Ä¶" list="brand-list" />
              <datalist id="brand-list">{allBrands.map(b=><option key={b} value={b}/>)}</datalist>
            </div>

            <div className="field">
              <label className="lbl">Tags <span style={{color:"#64748b",fontWeight:400,textTransform:"none",letterSpacing:0}}>‚Äî variants, e.g. "black-forest, sliced"</span></label>
              <TagInput tags={form.tags||[]} onChange={tags=>setForm(f=>({...f,tags}))} allTags={allTags} />
            </div>

            <div className="field-row cols-2">
              <div>
                <label className="lbl">Store</label>
                <input value={form.store||""} onChange={sf("store")} placeholder="e.g. Metro" list="store-list" />
                <datalist id="store-list">{allStores.map(s=><option key={s} value={s}/>)}</datalist>
              </div>
              <div>
                <label className="lbl">Category</label>
                <input value={form.category||""} onChange={sf("category")} placeholder="e.g. Dairy" list="cat-list" />
                <datalist id="cat-list">{allCats.map(c=><option key={c} value={c}/>)}</datalist>
              </div>
            </div>

            <div className="field-row cols-3">
              <div>
                <label className="lbl">Weight</label>
                <input type="number" value={form.weight||""} onChange={sf("weight")} placeholder="500" />
              </div>
              <div>
                <label className="lbl">Unit</label>
                <select value={form.unit||""} onChange={sf("unit")}>
                  {["","g","kg","mL","L","oz","lb"].map(u=><option key={u} value={u}>{u||"‚Äî"}</option>)}
                </select>
              </div>
              <div>
                <label className="lbl"># Units</label>
                <input type="number" min="1" value={form.units||""} onChange={sf("units")} placeholder="1" />
              </div>
            </div>

            <div className="field-row cols-2">
              <div>
                <label className="lbl">Total Price ($)</label>
                <input type="number" step="0.01" value={form.totalPrice||""} onChange={sf("totalPrice")} placeholder="4.99" />
              </div>
              <div>
                <label className="lbl">Regular Price ($)</label>
                <input type="number" step="0.01" value={form.regPrice||""} onChange={sf("regPrice")} placeholder="6.99" />
              </div>
            </div>

            <div className="field">
              <label className="lbl">Notes</label>
              <input value={form.notes||""} onChange={sf("notes")} placeholder="Optional" />
            </div>

            {form.totalPrice && (
              <div className="calc-preview">
                <div style={{width:"100%",fontSize:11,fontWeight:700,color:"#64748b",textTransform:"uppercase",letterSpacing:0.8,marginBottom:4}}>Auto-calculated</div>
                {[["$/unit",preview.pricePerUnit],["$/100g",preview.pricePer100g],["$/kg",preview.pricePerKg],["Saving",preview.saving]].map(([l,v])=>v!=null?(
                  <div key={l} style={{display:"flex",flexDirection:"column",gap:2}}>
                    <span className="calc-lbl">{l}</span>
                    <span className="calc-val">{fmt$(v)}</span>
                  </div>
                ):null)}
              </div>
            )}

            <button className="btn btn-primary"   onClick={save}>{editId?"Save Changes":"Add Entry"}</button>
            <button className="btn btn-secondary" onClick={cancel}>Cancel</button>
          </div>
        </div>
      )}

      {/* ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ */}
      {tab==="analytics" && (
        <div className="page">
          {entries.length===0
            ? <div className="empty"><div className="empty-icon">üìä</div><div className="empty-text">No data yet.</div></div>
            : <>
                <div className="search-wrap">
                  <span className="search-icon">üîç</span>
                  <input ref={analyticsSearchRef} value={analyticsSearch}
                    onChange={e=>setAnalyticsSearch(e.target.value)}
                    placeholder="Search product or brand‚Ä¶" />
                  {analyticsSearch&&<button className="search-clear" onClick={()=>{setAnalyticsSearch("");analyticsSearchRef.current?.focus();}}>√ó</button>}
                </div>

                <div className="stat-grid">
                  {[
                    ["Entries",   entries.length,                           "#60a5fa"],
                    ["Products",  allProducts.length,                       "#4ade80"],
                    ["Brands",    allBrands.length,                         "#a78bfa"],
                    ["Stores",    allStores.length,                         "#fbbf24"],
                  ].map(([lbl,val,color])=>(
                    <div key={lbl} className="stat-card" style={{borderTop:`3px solid ${color}`}}>
                      <div className="stat-val" style={{color}}>{val}</div>
                      <div className="stat-lbl">{lbl}</div>
                    </div>
                  ))}
                </div>

                {allTags.length>0&&(
                  <div className="card" style={{padding:"12px 14px"}}>
                    <div style={{fontSize:11,fontWeight:700,color:"#64748b",textTransform:"uppercase",letterSpacing:0.8,marginBottom:8}}>Filter by tag</div>
                    <div className="analytics-tag-bar">
                      <button className={`analytics-tag-chip${!analyticsTag?" active":""}`} onClick={()=>setAnalyticsTag(null)}>All</button>
                      {allTags.map(({tag,count})=>(
                        <button key={tag} className={`analytics-tag-chip${analyticsTag===tag?" active":""}`} onClick={()=>setAnalyticsTag(analyticsTag===tag?null:tag)}>
                          #{tag} <span style={{opacity:0.5,marginLeft:3}}>{count}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                <div className="card">
                  <div className="section-title">Price breakdown{analyticsTag?` ‚Äî #${analyticsTag}`:""}{analyticsSearch?` ‚Äî "${analyticsSearch}"`:""}</div>
                  {filteredAnalytics.length===0
                    ? <div style={{color:"#64748b",fontSize:13}}>No entries match{analyticsSearch?" your search":""}.</div>
                    : filteredAnalytics.map(p=>(
                    <div key={p.product} className="product-row">
                      <div className="product-name">{p.product} <span style={{fontWeight:400,color:"#64748b",fontSize:12}}>({p.count} record{p.count!==1?"s":""})</span></div>

                      {/* Product-level summary */}
                      <div style={{display:"flex",gap:10,flexWrap:"wrap",margin:"6px 0 2px",paddingLeft:2}}>
                        {[["Avg",p.avgPrice,"#e2e8f0"],["Min",p.minPrice,"#4ade80"],["Max",p.maxPrice,"#f87171"]].map(([l,v,c])=>fmt$(v)?(
                          <div key={l} style={{fontSize:13}}>
                            <span style={{color:"#64748b",fontSize:11}}>{l} </span>
                            <strong style={{color:c}}>{fmt$(v)}</strong>
                          </div>
                        ):null)}
                      </div>
                      {p.unitLabel && (
                        <div style={{display:"flex",gap:10,flexWrap:"wrap",margin:"2px 0 4px",paddingLeft:2}}>
                          {[["Avg "+p.unitLabel,p.unitAvg,"#e2e8f0"],["Min "+p.unitLabel,p.unitMin,"#4ade80"],["Max "+p.unitLabel,p.unitMax,"#f87171"]].map(([l,v,c])=>v!=null?(
                            <div key={l} style={{fontSize:13}}>
                              <span style={{color:"#64748b",fontSize:11}}>{l} </span>
                              <strong style={{color:c}}>{fmt$3(v)}</strong>
                            </div>
                          ):null)}
                        </div>
                      )}

                      {p.brandData.map(b=>(
                        <div key={b.brand} className="brand-block">
                          <div className="brand-title">
                            {b.brand}
                            <span style={{fontWeight:400,color:"#64748b",marginLeft:6,fontSize:11}}>({b.count})</span>
                          </div>
                          <div style={{display:"flex",gap:8,flexWrap:"wrap",margin:"4px 0 6px"}}>
                            {[["avg",b.avgPrice],["min",b.minPrice],["max",b.maxPrice]].map(([l,v])=>fmt$(v)?(
                              <span key={l} style={{fontSize:11,color:"#94a3b8"}}>{l} <strong style={{color:l==="min"?"#4ade80":l==="max"?"#f87171":"#e2e8f0"}}>{fmt$(v)}</strong></span>
                            ):null)}
                            {p.unitLabel && b.bUnitAvg!=null && (
                              <>
                                <span style={{fontSize:11,color:"#1e3a5f"}}>‚îÇ</span>
                                {[["avg",b.bUnitAvg],["min",b.bUnitMin],["max",b.bUnitMax]].map(([l,v])=>v!=null?(
                                  <span key={l+"u"} style={{fontSize:11,color:"#94a3b8"}}>{l} <strong style={{color:l==="min"?"#4ade80":l==="max"?"#f87171":"#7dd3fc"}}>{fmt$3(v)}</strong><span style={{color:"#475569",fontSize:10}}>/{p.unitLabel.replace("$/","")}</span></span>
                                ):null)}
                              </>
                            )}
                          </div>

                          {b.storeAvgs.length > 0 && (
                            <div className="store-bars">
                              {b.storeAvgs.map((sv,i)=>{
                                const unitAvg = b.storeUnitAvgs?.find(su=>su.store===sv.store);
                                return (
                                <div key={sv.store} className="store-bar">
                                  <div className="store-name" style={{color:i===0?"#4ade80":i===b.storeAvgs.length-1&&i>0?"#f87171":"#94a3b8"}}>
                                    {i===0&&b.storeAvgs.length>1 ? "‚úì " : ""}{sv.store}
                                  </div>
                                  <div className="bar-track">
                                    <div className="bar-fill" style={{
                                      width:`${(sv.avg/b.maxAvg*100).toFixed(1)}%`,
                                      background: i===0?"#4ade80":i===b.storeAvgs.length-1&&i>0?"#f87171":"#3b82f6"
                                    }}/>
                                  </div>
                                  <div className="store-price" style={{color:i===0?"#4ade80":i===b.storeAvgs.length-1&&i>0?"#f87171":"#e2e8f0"}}>
                                    {fmt$(sv.avg)}
                                    {unitAvg && p.unitLabel && <div style={{fontSize:10,color:"#64748b",fontWeight:400}}>{fmt$3(unitAvg.avg)}/{p.unitLabel.replace("$/","")}</div>}
                                  </div>
                                </div>
                              );})}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  ))}
                </div>
              </>
          }
        </div>
      )}

      {/* ‚îÄ‚îÄ SYNC TAB ‚îÄ‚îÄ */}
      {tab==="sync" && (
        <div className="page">
          <div className="card">
            <div className="section-title">Cloud sync</div>
            <p style={{fontSize:14,color:"#94a3b8",marginBottom:14,lineHeight:1.6}}>
              Syncs automatically on open and 1.5s after every save. Both you and your mom use the same Lambda URL and secret ‚Äî last edit always wins.
            </p>
            <div style={{background:"#0d1117",borderRadius:10,padding:"12px 14px",marginBottom:14,fontSize:13,color:"#64748b",lineHeight:1.8}}>
              <div>Status: <strong style={{color:syncStatus==="synced"?"#4ade80":syncStatus==="error"?"#fca5a5":"#93c5fd"}}>{syncStatus}</strong></div>
              {lastSynced&&<div>Last synced: <strong style={{color:"#e2e8f0"}}>{lastSynced.toLocaleTimeString()}</strong></div>}
              <div>Entries in database: <strong style={{color:"#e2e8f0"}}>{entries.length}</strong></div>
            </div>
            <button className="btn btn-primary" onClick={()=>pullCloud(secret)}>üîÑ Sync now</button>
          </div>
          <div className="card">
            <div className="section-title">Change secret key</div>
            <p style={{fontSize:14,color:"#94a3b8",marginBottom:12,lineHeight:1.6}}>Update the key saved on this device.</p>
            <input type="password" placeholder="New secret key‚Ä¶" value={secretInput} onChange={e=>setSecretInput(e.target.value)} style={{marginBottom:10}} />
            <button className="btn btn-warning" onClick={saveSecret}>Update key</button>
          </div>
          <div className="card">
            <div className="section-title">File backup</div>
            <p style={{fontSize:14,color:"#94a3b8",marginBottom:14,lineHeight:1.6}}>Download or restore a local backup, independent of cloud sync.</p>
            <button className="btn btn-success" onClick={exportData}>‚¨áÔ∏è Export backup</button>
            <input ref={importRef} type="file" accept=".json,application/json" style={{display:"none"}} onChange={importData} />
            <button className="btn btn-secondary" onClick={()=>importRef.current.click()}>‚¨ÜÔ∏è Import backup</button>
          </div>
        </div>
      )}

      {/* Toast */}
      {toast && <div className="toast">{toast}</div>}

    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
